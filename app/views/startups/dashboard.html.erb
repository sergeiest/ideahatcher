<%= render "startups/nav" %>

<div class="hatcher-container">
  <div class="company-main">
    <div class="company-left">
      <div class="company-content">
        <% @descriptions.each do |description| %>
            <div class="company-box" id="div_<%= description.id%>">
              <h5><%= description.field_status %></h5>
              <% if description.companydescription_id %>

                <div id="description_<%= description.id%>" class="ab-test">
                    <div class="my_corner previous-test"></div>
                    <div class="idea-statement current-test">
                        <% old_description = Companydescription.find(description.companydescription_id) %>
                        <%= simple_format old_description.content.firstletters(250),
                                          :class => "p_old" %>
                        <% old_description.approval_status = 0 if !old_description.approval_status %>
                        <p class="approval_status"><%= old_description.approval_status %> people like this</p>
                    </div>
                    <button class="btn btn-mini btn-primary edit-text" onclick=editDescription(this)>Edit</button>

                    <div class="my_corner next-test"></div>
                    <div class="idea-statement next-test">
                        <%= simple_format description.content.firstletters(250),
                                            :class => "p_new" %>
                        <%= form_tag({:action => "new_suggestion", :controller => "companydescriptions"},
                                       :multipart => true,
                                       :hidden => true,
                                       :class => "next-test",
                                       :remote => true) do %>
                            <%= hidden_field :companydescription, :companydescription_id, :value => description.id %>
                            <%= text_area :companydescription, :content%>
                            <%= submit_tag 'Save', class: "btn btn-mini btn-primary"%>
                        <% end %>
                        <% description.approval_status = 0 if !description.approval_status %>
                        <p class="approval_status"><%= description.approval_status %> people like this</p>
                    </div>
                    <div class="my_corner " hidden></div>
                    <div class="clear-both"></div>
                </div>

              <% else %>

                <div id="description_<%= description.id%>" class="ab-test">
                  <div class="my_corner previous-test"></div>
                  <div class="idea-statement current-test">
                        <%= simple_format description.content, :class => "p_old" %>
                  </div>
                  <button class="btn btn-mini btn-primary edit-text" onclick=addDescription(this)>Edit</button>
                  <div class="my_corner next-test" hidden></div>
                  <div class="idea-statement next-test" hidden>
                      <p class="p_new"></p>
                      <%= form_tag({:action => "new_suggestion", :controller => "companydescriptions"},
                                       :multipart => true,
                                       :class => "next-test",
                                       :remote => true) do %>
                            <%= hidden_field :companydescription, :companydescription_id, :value => description.id %>
                            <%= text_area :companydescription, :content%>
                            <%= submit_tag 'Save', class: "btn btn-mini btn-primary"%>
                      <% end %>
                  </div>

                  <div class="clear-both"></div>
                </div>

              <% end %>

              <%= link_to({:action => 'show_votes', :controller => 'votes',
                                                            :description_id => description.id},
                                      :id => "chart_link",
                                      :remote => true,
                                      :style => "cursor:pointer; font-size:12px;") do %>
                Show votes<i class=' icon-chevron-down glyphw '></i>
              <% end %> |
              <a onclick="showIdeas(this)" style="cursor:pointer; font-size:12px;">
                Show/add comments<i class=' icon-chevron-down glyphw '></i>
              </a>
              <div id="visualization_<%= description.id%>"></div>
              <div name="ideas" hidden id="following_Idea<%= description.id %>">
                <% @ideas.select{|a| a.companydescription_id == description.id }.each do |idea| %>
                    <%= simple_format idea.content %>
                    <div class="author">
                      <p><%= idea.first_name %> <%= idea.last_name %> on <%= idea.created_at.strftime('%m/%d/%Y') %></p>
                    </div>
                    <hr/>
                <% end %>
                <%= form_tag({:controller => "ideas", :action => "create"},
                             :remote => true) do %>
                    <%= hidden_field :idea, :title, :value => description.field_status %>
                    <%= hidden_field :idea, :is_protected, :value => 0 %>
                    <%= hidden_field :idea, :idea_id, :value => "" %>
                    <%= hidden_field :idea, :startup_id, :value => @startup.id %>
                    <%= hidden_field :idea, :companydescription_id, :value => description.id %>
                    <%= text_area :idea, :content%>
                    <button class="btn btn-warning">Save</button>
                <% end %>
              </div>
            </div>
        <% end %>
      </div>
    </div>
    <div class="clear-both"></div>
  </div>
</div>

<div class="guideline-menu">
  <h5>What to do here</h5>
  <p>You can check how people voted and what they suggested regarding your idea</p>
</div>



<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript">
    google.load('visualization', '1', {packages: ['corechart']});
</script>


<script>
    $('.my_corner').prepend('<div class="tr"></div>')
            .prepend('<div class="tl"></div>')
            .prepend('<div class="br"></div>')
            .prepend('<div class="bl"></div>');
</script>

<script>
    function editDescription(elementNode){

        var descriptionDiv = elementNode.parentNode.parentNode;

        var nextElements = descriptionDiv.getElementsByClassName('next-test');

        var oldContent = descriptionDiv.getElementsByClassName('p_old')[0];
        var newContent = descriptionDiv.getElementsByClassName('p_new')[0];

        oldContent.innerHTML = newContent.innerHTML;

        for (var i = 0; i < nextElements.length; i++) {
            nextElements[i].hidden = false;
            if (nextElements[i].getElementsByTagName('p').length > 0){
                nextElements[i].getElementsByTagName('p')[0].hidden = true;
            }
        }
        nextElements.getElementsByTagName('form')[0].hidden = false;
        elementNode.hidden = true;
    }

    function addDescription(elementNode){

        notes = elementNode.parentNode.children;

        for (var i = 0; i < notes.length; i++) {
            notes[i].hidden = false;
        }

        elementNode.parentNode.getElementsByTagName('form')[0].hidden = false;
        elementNode.hidden = true;
    }

    function showIdeas(elementNode) {
        notes = elementNode.parentNode.children;
        for (var i = 0; i < notes.length; i++) {
            if (notes[i].getAttribute('name') == "ideas") {
                ideasDiv = notes[i];
            }
        }
        if (ideasDiv.hidden == true) {
            elementNode.innerHTML = "Hide comments<i class='icon-chevron-up glyphw'></i>";
            ideasDiv.hidden = false;
        } else {
            elementNode.innerHTML = "Show/add comments<i class=' icon-chevron-down glyphw '></i>";
            ideasDiv.hidden = true;
        }
    }

    function showVotes(elementNode, id) {
        ideasDiv = document.getElementById('visualization_' + id)
        if (ideasDiv.hidden == true) {
            elementNode.innerHTML = "Hide votes<i class='icon-chevron-up glyphw'></i>";
            ideasDiv.hidden = false;
        } else {
            elementNode.innerHTML = "Show votes<i class=' icon-chevron-down glyphw '></i>";
            ideasDiv.hidden = true;
        }
    }

</script>